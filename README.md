# Руководство по прошивке термостата на AVR

## Назначение
Прошивка предназначена для работы в качестве термостата с датчиками температуры DS18B20. Система контролирует температуру и управляет реле в зависимости от показаний датчиков.

## Используемые пины микроконтроллера

| Пин | Обозначение | Назначение |
|-----|-------------|------------|
| PB3 | PIN_DS1820 | Подключение датчиков температуры DS18B20 (1-Wire) |
| PB4 | PIN_RELAY | Управление реле |
| PB2 | PIN_UART_TX | Передача данных по UART |

## Подключение
1. **Датчики температуры DS18B20:**
   - Сигнальный провод подключается к пину PB3
   - Требуется подтягивающий резистор 4.7кОм между сигнальным проводом и питанием
   - Поддерживается до 4 датчиков на одной шине

2. **Реле:**
   - Управляющий сигнал подключается к пину PB4
   - Реле активируется при высоком уровне сигнала

3. **UART:**
   - Передающая линия TX подключается к пину PB2
   - Скорость передачи: 9600 бод
   - Формат: 8N1 (8 бит данных, без бита чётности, 1 стоп-бит)

## Принцип работы
1. При запуске система пытается найти подключенные датчики DS18B20 (до 4 штук)
2. Если датчики не найдены, система отправляет сообщение 'N' по UART и останавливается
3. Циклически опрашиваются все найденные датчики
4. Температурные значения отправляются по UART в формате: `[номер_датчика]:[температура]`
5. Реле управляется по гистерезису:
   - Включается при превышении верхнего порога (25°C)
   - Выключается при падении ниже нижнего порога (23°C)
6. Состояние реле отправляется по UART в формате: `R:[состояние]`

## Детальная логика управления реле

### Алгоритм работы
1. Система опрашивает все найденные датчики и проверяет их показания
2. Устанавливаются два флага:
   - `above` - хотя бы один датчик показал температуру выше верхнего порога
   - `below` - все датчики показывают температуру ниже нижнего порога

### Логика включения
- Реле **включается** (PORTB |= (1 << PIN_RELAY)), если:
  - Реле в данный момент выключено (`relay = 0`)
  - И хотя бы один из датчиков показывает температуру выше верхнего порога (`above = 1`)
  - Это позволяет системе реагировать на перегрев в любой зоне контроля

### Логика выключения
- Реле **выключается** (PORTB &= ~(1 << PIN_RELAY)), если:
  - Реле в данный момент включено (`relay = 1`) 
  - И все датчики показывают температуру ниже нижнего порога (`below = 1`)
  - Это предотвращает преждевременное отключение, пока не остынут все контролируемые зоны

### Гистерезис
Разница между верхним (25°C) и нижним (23°C) порогами создает гистерезис в 2°C, что:
- Предотвращает частое включение/выключение реле при колебаниях температуры
- Снижает износ коммутационных элементов
- Обеспечивает стабильную работу подключенных устройств

### Поведение в краевых случаях
- Если температура находится между верхним и нижним порогами (23-25°C):
  - Реле сохраняет свое текущее состояние
  - Это создает зону нечувствительности и предотвращает "дребезг" реле

## Пороговые значения
- **Верхний порог:** 25°C (400 / 16)
- **Нижний порог:** 23°C (368 / 16)

## Формат вывода UART
- **Данные датчиков:** `[номер_датчика]:[температура]`
  - Пример: `1:24`
- **Состояние реле:** `R:[0/1]`
  - Пример: `R:1` (реле включено)
- **Ошибка:** `N` (отправляется, если датчики не найдены)
